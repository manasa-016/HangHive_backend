<!DOCTYPE html>
<html>
<head>
    <title>Voice Call</title>
</head>
<body>
    <h2>Voice Call Test</h2>

    <input id="roomInput" placeholder="Enter Room ID" />
    <button onclick="joinRoom()">Join Room</button>
    <button onclick="startCall()">Call</button>

    <script>
        let socket;
        let peerConnection;
        let localStream;
        let roomId;

        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        async function joinRoom() {
            roomId = document.getElementById("roomInput").value;

            socket = new WebSocket(`ws://127.0.0.1:8000/ws/${roomId}`);

            socket.onopen = () => {
                console.log("Connected to signaling server");
            };

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);

                if (data.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.send(JSON.stringify({ answer }));
                }

                if (data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                }

                if (data.ice) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.ice));
                    } catch (e) {
                        console.error("ICE error:", e);
                    }
                }
            };

            await initPeer();
        }

        async function initPeer() {
            peerConnection = new RTCPeerConnection(config);

            // Get microphone
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({ ice: event.candidate }));
                }
            };

            peerConnection.ontrack = (event) => {
                console.log("Receiving audio");

                const remoteAudio = document.createElement("audio");
                remoteAudio.srcObject = event.streams[0];
                remoteAudio.autoplay = true;
                remoteAudio.controls = true;
                document.body.appendChild(remoteAudio);

                remoteAudio.play().catch(e => {
                    console.log("Autoplay blocked, user interaction needed");
                });
            };
        }

        async function startCall() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.send(JSON.stringify({ offer }));
        }
    </script>
</body>
</html>
